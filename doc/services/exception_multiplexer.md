# 异常选择器

异常选择服务提供了注册流水线上会产生的异常，进行优先级选择的方法。
相关实现代码位于[ExceptionMux](/ZenCove/src/zencove/core/ExceptionMux.scala)。

## 简介

在Plugin的setup方法中，可以对流水线上产生的异常、其异常使能信号、badVA（可选）进行注册。

异常的优先级顺序由异常阶段和其优先级数值决定。先前阶段已产生异常的指令不会被新的异常覆盖，同一阶段异常优先级按照优先级数值从大到小。

在异常处理阶段的流水线信号中，可以直接抓取到ExceptionMux生成的最终异常信号。

## 注意事项

TLB重填异常在MIPS中与TLB无效异常占用了同样的异常码，然而需要区分其跳转目标。因此异常实际需要携带1 bit ISA不可见的标记是否是TLB重填，这在ExceptionMux里没有得到很好的支持，目前是硬写在地址转换组件中。这可以在ExceptionMux中进行修复。

标量场景下32位的badVA可以一路携带，然而乱序场景下各种buffer必须尽量消除这种极宽的域。显然badVA除非是load/store执行产生的异常（这与取指令异常不一定有异常码区分），否则必然是PC。因此取指令流水忽略了badVA。

乱序的流水之间通过buffer隔开了，使得依赖流水线存储异常状态的ExceptionMux被打断了，因此乱序中实际上这一服务的效果并不显著。
